// ‰∫§‰∫íÊéßÂà∂Ê®°Âùó

// Èü≥‰πêÊéßÂà∂
class MusicController {
    constructor() {
        this.audio = document.getElementById('bgMusic');
        this.toggleBtn = document.getElementById('musicToggle');
        this.isPlaying = false;
        this.init();
    }

    init() {
        // ËÆæÁΩÆÈü≥È¢ëÂ±ûÊÄß
        this.audio.volume = 0.3;
        this.audio.loop = true;

        // ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
        this.toggleBtn.addEventListener('click', () => this.toggle());

        // È°µÈù¢ÂèØËßÅÊÄßÊîπÂèòÊó∂ÊöÇÂÅú/Êí≠Êîæ
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && this.isPlaying) {
                this.pause();
            }
        });
    }

    async toggle() {
        try {
            if (this.isPlaying) {
                this.pause();
            } else {
                await this.play();
            }
        } catch (error) {
            console.log('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', error);
        }
    }

    async play() {
        try {
            await this.audio.play();
            this.isPlaying = true;
            this.updateButton();
            this.startVisualizer();
        } catch (error) {
            console.log('Êó†Ê≥ïÊí≠ÊîæÈü≥È¢ë:', error);
        }
    }

    pause() {
        this.audio.pause();
        this.isPlaying = false;
        this.updateButton();
        this.stopVisualizer();
    }

    updateButton() {
        const icon = this.toggleBtn.querySelector('.music-icon');
        const text = this.toggleBtn.querySelector('.music-text');
        
        if (this.isPlaying) {
            icon.textContent = 'üéµ';
            text.textContent = 'Êí≠Êîæ‰∏≠';
            this.toggleBtn.style.background = 'rgba(46, 213, 115, 0.9)';
        } else {
            icon.textContent = 'üîá';
            text.textContent = 'ÁÇπÂáªÊí≠Êîæ';
            this.toggleBtn.style.background = 'rgba(255, 255, 255, 0.9)';
        }
    }

    startVisualizer() {
        // ÁÆÄÂçïÁöÑÈü≥‰πêÂèØËßÜÂåñÊïàÊûú
        this.toggleBtn.classList.add('animate-pulse');
    }

    stopVisualizer() {
        this.toggleBtn.classList.remove('animate-pulse');
    }

    setVolume(volume) {
        this.audio.volume = Math.max(0, Math.min(1, volume));
    }
}

// ÁâπÊïàËß¶ÂèëÂáΩÊï∞
function triggerFireworks() {
    // ÊåâÈíÆÂä®Áîª
    const btn = event.target;
    btn.classList.add('animate-rubber');
    
    // ÂêØÂä®ÁÉüËä±
    if (window.AnimationEffects) {
        window.AnimationEffects.fireworks.start();
        changeParticleMode('party');
    }
    
    // ËÉåÊôØÂèòÂåñ
    setTimeout(() => {
        if (window.AnimationEffects) {
            window.AnimationEffects.background.changeGradient();
        }
    }, 1000);
    
    // ÁßªÈô§ÊåâÈíÆÂä®Áîª
    setTimeout(() => {
        btn.classList.remove('animate-rubber');
    }, 1000);
}

function triggerConfetti() {
    const btn = event.target;
    btn.classList.add('animate-bounce');
    
    // ÂêØÂä®ÂΩ©Â∏¶Èõ®
    if (window.AnimationEffects) {
        window.AnimationEffects.confetti.start();
        window.AnimationEffects.hearts.create(8);
    }
    
    // ‰∏ªÂõæÊ†áÂä®Áîª
    const mainIcon = document.querySelector('.main-icon');
    if (mainIcon) {
        mainIcon.classList.add('animate-heartbeat');
        setTimeout(() => {
            mainIcon.classList.remove('animate-heartbeat');
        }, 2000);
    }
    
    setTimeout(() => {
        btn.classList.remove('animate-bounce');
    }, 2000);
}

function blowCandles() {
    const btn = event.target;
    btn.classList.add('animate-glow');
    
    // ÊòæÁ§∫È≠îÊ≥ïÊïàÊûú
    const magicEffect = document.getElementById('magicEffect');
    magicEffect.style.opacity = '1';
    
    // È≠îÊ≥ïÁ≤âÂ∞òÊïàÊûú
    if (window.AnimationEffects) {
        const rect = btn.getBoundingClientRect();
        window.AnimationEffects.magic.createAt(
            rect.left + rect.width / 2,
            rect.top + rect.height / 2
        );
        
        // Ê∞îÊ≥°ÊïàÊûú
        window.AnimationEffects.bubbles.createBubbles(15);
    }
    
    // ÁâπËâ≤ÊñáÂ≠óÂä®Áîª
    const featureText = document.getElementById('featureText');
    if (featureText) {
        const messages = [
            '‚ú® ÂàõÊÑèÁÇπÁáÉÊó†ÈôêÂèØËÉΩÁöÑÁÅ´Ëä±ÔºÅ',
            'üåü ËÆ©ÊÉ≥Ë±°ÂäõÂú®Áé∞ÂÆû‰∏≠ÁªΩÊîæÂÖâËäíÔºÅ',
            'üé® ÊØè‰∏ÄÊ¨°ÂàõÊñ∞ÈÉΩÊòØËâ∫ÊúØÁöÑËØûÁîüÔºÅ',
            'üí´ ÁßëÊäÄ‰∏éËâ∫ÊúØÁöÑÂÆåÁæéËûçÂêàÔºÅ',
            'üöÄ Êé¢Á¥¢Êú™Áü•ÔºåÂàõÈÄ†Â•áËøπÔºÅ'
        ];
        
        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
        window.AnimationEffects.text.typewriter(featureText, randomMessage, 80);
    }
    
    // ÈöêËóèÈ≠îÊ≥ïÊïàÊûú
    setTimeout(() => {
        magicEffect.style.opacity = '0';
        btn.classList.remove('animate-glow');
    }, 2000);
}

// Èº†Ê†áË∑üË∏™È≠îÊ≥ïÊïàÊûú
class MouseMagic {
    constructor() {
        this.lastX = 0;
        this.lastY = 0;
        this.particles = [];
        this.init();
    }

    init() {
        document.addEventListener('mousemove', (e) => this.handleMouseMove(e));
        this.animate();
    }

    handleMouseMove(e) {
        const dx = e.clientX - this.lastX;
        const dy = e.clientY - this.lastY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance > 10 && window.AnimationEffects) {
            // ÂàõÂª∫Ë∑üË∏™Á≤íÂ≠ê
            this.createTrailParticle(e.clientX, e.clientY);
        }
        
        this.lastX = e.clientX;
        this.lastY = e.clientY;
    }

    createTrailParticle(x, y) {
        const particle = document.createElement('div');
        particle.className = 'light-particle';
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.setProperty('--end-x', (Math.random() - 0.5) * 100 + 'px');
        particle.style.setProperty('--end-y', (Math.random() - 0.5) * 100 + 'px');
        
        document.body.appendChild(particle);
        
        setTimeout(() => particle.remove(), 3000);
    }

    animate() {
        // Âä®ÁîªÂæ™ÁéØ
        requestAnimationFrame(() => this.animate());
    }
}

// ÈîÆÁõòÂø´Êç∑ÈîÆ
class KeyboardShortcuts {
    constructor() {
        this.init();
    }

    init() {
        document.addEventListener('keydown', (e) => this.handleKeyPress(e));
    }

    handleKeyPress(e) {
        switch(e.key.toLowerCase()) {
            case 'f':
                triggerFireworks();
                break;
            case 'c':
                triggerConfetti();
                break;
            case 'b':
                blowCandles();
                break;
            case ' ':
                e.preventDefault();
                if (window.musicController) {
                    window.musicController.toggle();
                }
                break;
            case 'r':
                // ÈáçÁΩÆÊâÄÊúâÊïàÊûú
                location.reload();
                break;
        }
    }
}

// Ëß¶Êë∏ËÆæÂ§áÊîØÊåÅ
class TouchSupport {
    constructor() {
        this.init();
    }

    init() {
        // Ëß¶Êë∏ÂºÄÂßã
        document.addEventListener('touchstart', (e) => this.handleTouchStart(e));
        
        // Ëß¶Êë∏ÁßªÂä®
        document.addEventListener('touchmove', (e) => this.handleTouchMove(e));
        
        // ÈïøÊåâÊïàÊûú
        let touchTimer;
        document.addEventListener('touchstart', (e) => {
            touchTimer = setTimeout(() => {
                this.createTouchEffect(e.touches[0].clientX, e.touches[0].clientY);
            }, 500);
        });
        
        document.addEventListener('touchend', () => {
            clearTimeout(touchTimer);
        });
    }

    handleTouchStart(e) {
        const touch = e.touches[0];
        this.createRipple(touch.clientX, touch.clientY);
    }

    handleTouchMove(e) {
        e.preventDefault();
        const touch = e.touches[0];
        if (window.AnimationEffects) {
            window.AnimationEffects.magic.createAt(touch.clientX, touch.clientY);
        }
    }

    createRipple(x, y) {
        const ripple = document.createElement('div');
        ripple.style.position = 'fixed';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        ripple.style.width = '20px';
        ripple.style.height = '20px';
        ripple.style.borderRadius = '50%';
        ripple.style.background = 'radial-gradient(circle, rgba(255,255,255,0.6), transparent)';
        ripple.style.transform = 'translate(-50%, -50%)';
        ripple.style.pointerEvents = 'none';
        ripple.style.animation = 'rippleExpand 0.6s ease-out forwards';
        
        document.body.appendChild(ripple);
        
        setTimeout(() => ripple.remove(), 600);
    }

    createTouchEffect(x, y) {
        if (window.AnimationEffects) {
            window.AnimationEffects.magic.createAt(x, y);
            window.AnimationEffects.hearts.create(3);
        }
    }
}

// Ëá™Âä®Êí≠ÊîæÊèêÁ§∫
class AutoplayHelper {
    constructor() {
        this.hasShownPrompt = false;
        this.init();
    }

    init() {
        // Á≠âÂæÖÁî®Êà∑È¶ñÊ¨°‰∫§‰∫íÂêéÂ∞ùËØïÊí≠ÊîæÈü≥‰πê
        const events = ['click', 'touchstart', 'keydown'];
        events.forEach(event => {
            document.addEventListener(event, () => this.tryAutoplay(), { once: true });
        });
    }

    async tryAutoplay() {
        if (!this.hasShownPrompt && window.musicController) {
            this.hasShownPrompt = true;
            
            // ÊòæÁ§∫Èü≥‰πêÊèêÁ§∫
            this.showMusicPrompt();
        }
    }

    showMusicPrompt() {
        const prompt = document.createElement('div');
        prompt.innerHTML = `
            <div style="
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 15px 25px;
                border-radius: 25px;
                z-index: 1000;
                font-size: 14px;
                backdrop-filter: blur(10px);
                animation: fadeInUp 0.5s ease-out forwards;
            ">
                üéµ ÁÇπÂáªÂè≥‰∏äËßíÊåâÈíÆÂºÄÂêØËÉåÊôØÈü≥‰πê üéµ
            </div>
        `;
        
        document.body.appendChild(prompt);
        
        setTimeout(() => {
            prompt.style.animation = 'fadeOut 0.5s ease-out forwards';
            setTimeout(() => prompt.remove(), 500);
        }, 3000);
    }
}

// ÂàùÂßãÂåñÊâÄÊúâ‰∫§‰∫íÊéßÂà∂
document.addEventListener('DOMContentLoaded', function() {
    // ÂàùÂßãÂåñÈü≥‰πêÊéßÂà∂Âô®
    window.musicController = new MusicController();
    
    // ÂàùÂßãÂåñÈº†Ê†áÈ≠îÊ≥ïÊïàÊûú
    window.mouseMagic = new MouseMagic();
    
    // ÂàùÂßãÂåñÈîÆÁõòÂø´Êç∑ÈîÆ
    window.keyboardShortcuts = new KeyboardShortcuts();
    
    // ÂàùÂßãÂåñËß¶Êë∏ÊîØÊåÅ
    window.touchSupport = new TouchSupport();
    
    // ÂàùÂßãÂåñËá™Âä®Êí≠ÊîæÂä©Êâã
    window.autoplayHelper = new AutoplayHelper();
    
    // Ê∑ªÂä†Âä†ËΩΩÂÆåÊàêÂä®Áîª
    setTimeout(() => {
        document.body.style.opacity = '1';
        changeParticleMode('celebration');
    }, 100);
});

// CSSÂä®ÁîªËæÖÂä©
const style = document.createElement('style');
style.textContent = `
    @keyframes rippleExpand {
        to {
            transform: translate(-50%, -50%) scale(10);
            opacity: 0;
        }
    }
    
    @keyframes fadeOut {
        to {
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
        }
    }
    
    body {
        opacity: 0;
        transition: opacity 0.5s ease-in;
    }
`;
document.head.appendChild(style); 